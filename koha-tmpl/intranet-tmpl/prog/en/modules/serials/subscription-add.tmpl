<!-- TMPL_INCLUDE NAME="doc-head-open.inc" -->
<title>Koha &rsaquo; Serials &rsaquo; <!-- TMPL_IF name="mod" --> Modify subscription to <!-- TMPL_VAR name="bibliotitle" --><!-- TMPL_ELSE -->New subscription<!-- /TMPL_IF --></title>
<!-- TMPL_INCLUDE NAME="doc-head-close.inc" -->
<!-- TMPL_INCLUDE NAME="calendar.inc" -->

<script type="text/javascript">

var globalnumpatterndata;
var globalfreqdata;

function isDefined(variable){
    return (typeof(window[variable]) == 'undefined')? false : true;
}

function isArray(obj) {
if (obj.constructor.toString().indexOf("Array") == -1)
    return false;
else
    return true;
}

function check_issues(){
    if (globalfreqdata.unit.length >0) {
        if (document.f.subtype.value == globalfreqdata.unit){
            document.f.issuelengthcount.value=(document.f.sublength.value*globalfreqdata.issuesperunit)/globalfreqdata.unitsperissue;
        } else if (document.f.subtype.value != "issues"){
            alert(_("Frequency and subscription length provided doesn't combine well. Please consider entering an issue count rather than a time period."));
        }
    }
}

function addbiblioPopup(biblionumber) {
    var destination = "/cgi-bin/koha/cataloguing/addbiblio.pl?mode=popup";
    if(biblionumber){
        destination += "&biblionumber="+biblionumber;
    }
    window.open(destination,'AddBiblioPopup','width=1024,height=768,toolbar=no,scrollbars=yes');
}

function Plugin(f)
{
    window.open('subscription-bib-search.pl','FindABibIndex','width=800,height=400,toolbar=no,scrollbars=yes');
}

function FindAcqui(f)
{
    window.open('acqui-search.pl','FindASupplier','width=800,height=400,toolbar=no,scrollbars=yes');
}

function Find_ISSN(f)
{
    window.open('issn-search.pl','FindABibIndex','width=800,height=400,toolbar=no,scrollbars=yes');
}

function Check_page1() {
    if ( $("#aqbooksellerid").val().length == 0) {
        input_box = confirm(_("If you wish to claim late or missing issues you must link this subscription to a vendor. Click OK to ignore or Cancel to return and enter a vendor"));
        if (input_box==false) {
            return false;
        }
    }
    if ($("#biblionumber").val().length == 0) {
        alert(_("You must choose or create a biblio"));
        return false;
    }

    return true;
}

function Check_page2(){
    if($("#acqui_date").val().length == 0){
        alert(_("You must choose a first publication date"));
        return false;
    }
    if($("#frequency").val().length == 0){
        alert(_("You must choose a frequency"));
        return false;
    }
    if($("#beginning_date").val().length == 0){
        alert(_("You must choose a start date"));
        return false;
    }
    if(($("#sublength").val().length == 0 && $("#enddate").val().length == 0)
    || ($("#sublength").val().length != 0 && $("#enddate").val().length != 0)){
        alert(_("You must choose a subscription length or an end date, but not them two."));
        return false;
    }

    return true;
}

function frequencyload(){
    $.getJSON("subscription-frequency.pl",{"frequency_id":document.f.frequency.value,ajax:'true'},
        function(freqdata){
            globalfreqdata=freqdata;
            if(globalnumpatterndata == undefined){
                if( document.f.numberpattern.value ){
                    numberpatternload();
                } else {
                    return false;
                }
            }
        }
    )
}

function numberpatternload(){
    $.getJSON("subscription-numberpattern.pl",{"numberpattern_id":document.f.numbering_pattern.value,ajax:'true'},
        function(numpatterndata){
            globalnumpatterndata=numpatterndata;
            if (globalnumpatterndata==undefined){
                return false;
            }
            document.f.numberingmethod.value=unescape(numpatterndata.numberingmethod);
            if(globalfreqdata == undefined){
                if(document.f.frequency.value){
                    frequencyload();
                } else {
                    alert(_("Please define frequency"));
                    return false;
                }
            }
            displaymoreoptions();
        }
    );
}

function displaymoreoptions() {
    if(globalnumpatterndata == undefined){
        $("#moreoptionst").hide();
        return false;
    }

    if(globalnumpatterndata.label1 || globalnumpatterndata.label2 || globalnumpatterndata.label3) {
        $("#moreoptionst").show();
    } else {
        $("#moreoptionst").hide();
    }

    $("#lastvaluetemp1").val('');
    $("#lastvaluetemp2").val('');
    $("#lastvaluetemp3").val('');

    if(globalnumpatterndata.label1) {
        $("#headerX").html(globalnumpatterndata.label1);
        $("#headerX").show();
        $("#beginsX").show();
    } else {
        $("#headerX").hide();
        $("#beginsX").hide();
    }
    if(globalnumpatterndata.label2) {
        $("#headerY").html(globalnumpatterndata.label2);
        $("#headerY").show();
        $("#beginsY").show();
    } else {
        $("#headerY").hide();
        $("#beginsY").hide();
    }
    if(globalnumpatterndata.label3) {
        $("#headerZ").html(globalnumpatterndata.label3);
        $("#headerZ").show();
        $("#beginsZ").show();
    } else {
        $("#headerZ").hide();
        $("#beginsZ").hide();
    }
}

function showPredictionPattern() {
    var frequencyid = $("#frequency").val();
    var numberpatternid = $("#numberpattern").val();
    var lastvaluetemp1 = $("#lastvaluetemp1").val();
    var lastvaluetemp2 = $("#lastvaluetemp2").val();
    var lastvaluetemp3 = $("#lastvaluetemp3").val();
    var firstacquidate = $("#acqui_date").val();
    $.ajax({
        url: "showpredictionpattern.pl",
        data: {
            'frequency':frequencyid,
            'numberpattern':numberpatternid,
            'lastvaluetemp1':lastvaluetemp1,
            'lastvaluetemp2':lastvaluetemp2,
            'lastvaluetemp3':lastvaluetemp3,
            'firstacquidate':firstacquidate
        },
        async: false,
        dataType: "text",
        success: function(data) {
            $("#displayexample").html(data);
        }
    });
}

function show_page_1() {
    $("#page_1").show();
    $("#page_2").hide();
    $("#page_number").text("1/2");
}
function show_page_2() {
    $("#page_1").hide();
    $("#page_2").show();
    $("#page_number").text("2/2");
    displaymoreoptions();
}


$(document).ready(function() {
    $("select#frequency").change(function(){
        frequencyload();
    });
    $("select#numberpattern").change(function(){
        numberpatternload();
    });

    show_page_1();
});
</script>
</head>
<body>
<!-- TMPL_INCLUDE NAME="header.inc" -->
<!-- TMPL_INCLUDE NAME="serials-search.inc" -->

<div id="breadcrumbs"><a href="/cgi-bin/koha/mainpage.pl">Home</a> &rsaquo; <a href="/cgi-bin/koha/serials/serials-home.pl">Serials</a> &rsaquo; <!-- TMPL_IF name="mod" --> Modify subscription for <span class="title"><!-- TMPL_VAR name="bibliotitle" --></span><!-- TMPL_ELSE -->New subscription<!-- /TMPL_IF --></div>

<div id="doc3" class="yui-t7">
    <div id="bd">
        <div class="yui-g">
            <h1><!-- TMPL_IF name="mod" --> Modify subscription for <i><!-- TMPL_VAR name="bibliotitle" --></i><!-- TMPL_ELSE -->Add a new subscription<!-- /TMPL_IF --> (<span id="page_number">1/2</span>)</h1>
            <form method="post" name="f" action="/cgi-bin/koha/serials/subscription-add.pl">
                <!-- TMPL_IF name="mod" -->
                    <input type="hidden" name="op" value="modsubscription" />
                    <input type="hidden" name="subscriptionid" value="<!-- TMPL_VAR name="subscriptionid" -->" />
                <!-- TMPL_ELSE -->
                    <input type="hidden" name="op" value="addsubscription" />
                <!-- /TMPL_IF -->
                <input type="hidden" name="user" value="<!-- TMPL_VAR name="loggedinusername" -->" />
                <input type="hidden" name="irreg_check" value="0" />

                <div id="page_1">
                    <div class="yui-u first">
                        <fieldset id="subscription_add_information" class="rows">
                            <legend>Subscription details</legend>
                            <ol>
                                <li><span class="label">Subscription #</span> <!--TMPL_VAR name="subscriptionid"--></li>
                                <li>
                                    <span class="label">Librarian: </span>            <!-- TMPL_VAR name="loggedinusername" -->
                                </li>
                                <li>
                                    <label for="aqbooksellerid">Vendor: </label>
                                    <input type="text" name="aqbooksellerid" id="aqbooksellerid" value="<!-- TMPL_VAR name="aqbooksellerid" -->" size="8" /> (<input type="text" name="aqbooksellername" value="<!-- TMPL_VAR name="aqbooksellername" -->" disabled="disabled" readonly="readonly" />) <a href="#" onclick="FindAcqui(f)">Search for a vendor</a>
                                </li>
                                <li>
                                    <label for="biblionumber">Biblio: (*)</label>
                                    <input type="text" name="biblionumber" id="biblionumber" value="<!-- TMPL_VAR name="bibnum" -->" size="8" />
                                    (<input type="text" name="title" value="<!-- TMPL_VAR name="bibliotitle" -->" disabled="disabled" readonly="readonly" />)
                                    <a href="#" onclick="Plugin(f)">Search for Biblio</a> | <!--TMPL_IF Name="mod"--><a href="#" onclick="addbiblioPopup(<!-- TMPL_VAR NAME="bibnum" -->); return false;">Edit biblio</a><!-- TMPL_ELSE -->
                                    <a href="#" onclick="addbiblioPopup(); return false;">Create Biblio</a><!--/TMPL_IF-->
                                </li>
                                <li class="radio">
                                    <!-- TMPL_IF name="serialsadditems" -->
                                        <p><input type="radio" id="serialsadditems-yes" name="serialsadditems" value="1" checked="checked" /><label for="serialsadditems-yes">create an item record when receiving this serial</label></p>
                                        <p><input type="radio" id="serialsadditems-no" name="serialsadditems" value="0" /><label for="serialsadditems-no">do not create an item record when receiving this serial </label></p>
                                    <!-- TMPL_ELSE -->
                                        <p><input type="radio" id="serialsadditems-yes" name="serialsadditems" value="1"/><label for="serialsadditems-yes">create an item record when receiving this serial</label></p>
                                        <p><input type="radio" id="serialsadditems-no" name="serialsadditems" value="0" checked="checked" /><label for="serialsadditems-no">do not create an item record when receiving this serial</label></p>
                                    <!-- /TMPL_IF -->
                                </li>
                                <li>
                                    <label for="callnumber">Call Number</label>
                                    <input type="text" name="callnumber" id="callnumber" value="<!-- TMPL_VAR name="callnumber" -->" size="20" />
                                </li>
                                <li>
                                    <label for="branchcode">Library</label>
                                    <select name="branchcode" id="branchcode" style="width: 20em;">
                                        <!-- TMPL_UNLESS NAME="Independantbranches" --><option value="">None</option><!-- /TMPL_UNLESS -->
                                        <!-- TMPL_LOOP name="branchloop" -->
                                            <!-- TMPL_IF NAME="selected" -->
                                                <option value="<!-- TMPL_VAR NAME="value" -->" selected="selected"><!-- TMPL_VAR NAME="branchname" --></option>
                                            <!-- TMPL_ELSE -->
                                                <option value="<!-- TMPL_VAR NAME="value" -->"><!-- TMPL_VAR NAME="branchname" --></option>
                                            <!-- /TMPL_IF -->
                                        <!-- /TMPL_LOOP -->
                                    </select> (select a library)
                                </li>
                                <li>
                                    <label for="notes">Public note</label>
                                    <textarea name="notes" id="notes" cols="30" rows="2"><!-- TMPL_VAR name="notes" --></textarea>
                                </li>
                                <li>
                                    <label for="internalnotes">Nonpublic note</label>
                                    <textarea name="internalnotes" id="internalnotes" cols="30" rows="2"><!-- TMPL_VAR name="internalnotes" --></textarea>
                                </li>
                                <li>
                                    <label for="letter">Patron notification </label>
                                    <!-- TMPL_IF NAME="letterloop" -->
                                       <select name="letter" id="letter">
                                            <option value="">None</option>
                                            <!-- TMPL_LOOP name="letterloop" -->
                                                <option value="<!-- TMPL_VAR name="value" -->" <!-- TMPL_IF name="selected" --> selected="selected" <!-- /TMPL_IF -->><!-- TMPL_VAR name="lettername" --></option>
                                            <!-- /TMPL_LOOP -->
                                        </select>
                                        <div class="inputnote">Select a notice and patrons on the routing list will be notified when new issues are received.</div>
                                    <!-- TMPL_ELSE -->
                                        <div class="inputnote">To notify patrons of new serial issues, you must <a href="/cgi-bin/koha/tools/letter.pl">define a notice</a>.</div>
                                    <!-- /TMPL_IF -->
                                </li>
                            </ol>

                            <div class="warning"><b>Note:</b>
                                <ul>
                                    <li>The subscription <b>must</b> be associated with a bibliographic record.</li>
                                    <li>You <b>must</b> select a vendor if you wish to generate claims.</li>
                                </ul>
                            </div>
                        </fieldset>
                        <fieldset class="action">
                            <input type="button" value="Next >>" onclick="if ( Check_page1() ) show_page_2();" style="float:right;" />
                        </fieldset>
                    </div>
                </div>

                <div id="page_2">
                    <div class="yui-u first">
                        <div id="subscription_form_planning">
                            <fieldset class="rows">
                                <legend>Serials planning</legend>
                                <ol>
                                    <li>
                                        <label for="firstacquidate">Publication date for the first expected issue this year: (*)</label>
                                        <input type="text" name="firstacquidate" value="<!-- TMPL_VAR name="firstacquidate" -->" size="13" maxlength="10" id="acqui_date" readonly="readonly" />
                                        <img src="<!-- TMPL_VAR Name="themelang" -->/lib/calendar/cal.gif" id="button2" style="cursor: pointer;" alt="Show Calendar" title="Show Calendar" />
                                        <!-- both scripts for calendar must follow the input field --> 
                                        <script type="text/javascript">
                                            Calendar.setup({
                                                inputField:"acqui_date",
                                                ifFormat       :   "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                button         :   "button2",
                                                align          :   "Tl"
                                            });
                                        </script>
                                        <script type="text/javascript">
                                            Calendar.setup({
                                                inputField     :   "acqui_date",
                                                ifFormat       :   "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                button         :   "acqui_date",
                                                align          :   "Tl"
                                            });
                                        </script>
                                    </li>
                                    <li>
                                        <label for="frequency">Frequency: (*)</label>
                                        <select name="frequency" size="1" id="frequency">
                                            <option value="">-- please choose --</option>
                                            <!--TMPL_LOOP Name="frequencies"-->
                                                <option value="<!--TMPL_VAR Name="id"-->" <!--TMPL_IF name="selected"--> selected="selected" <!-- /TMPL_IF -->>
                                                    <!--TMPL_VAR Name="label"-->
                                                </option>
                                            <!--/TMPL_LOOP-->
                                        </select>
                                    </li>
                                    <li>
                                        <label for="manuallist"> Manual history:</label>
                                        <input type="checkbox" name="manualhist" id="manuallist" value="1" />
                                    </li>
                                    <li>
                                        <label for="subtype">Subscription length:</label>
                                        <select name="subtype" id="subtype2">
                                            <!-- TMPL_LOOP NAME="subtype" -->
                                                <option value="<!-- TMPL_VAR NAME="name" -->" <!-- TMPL_IF NAME="selected" --> selected="selected" <!-- /TMPL_IF --> >
                                                    <!-- TMPL_VAR NAME="name" -->
                                                </option>
                                            <!-- /TMPL_LOOP -->
                                        </select>
                                        <input type="text" name="sublength" id="sublength" value="<!-- TMPL_VAR name="sublength" -->" size="3" /> (enter amount in numerals)
                                        <input type="hidden" name="issuelengthcount">
                                    </li>
                                    <li>
                                        <label for="startdate"> Subscription start date: (*)</label>
                                        <input type="text" name="startdate" value="<!-- TMPL_VAR name="startdate" -->" size="13" maxlength="10" id="beginning_date" readonly="readonly" />
                                        <img src="<!-- TMPL_VAR Name="themelang" -->/lib/calendar/cal.gif" id="button1" style="cursor: pointer;" alt="Show Calendar" title="Show Calendar" />
                                        <!-- both scripts for calendar must follow the input field --> 
                                        <script type="text/javascript">
                                            Calendar.setup({
                                                inputField   : "beginning_date",
                                                ifFormat     : "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                button       : "button1",
                                                align        : "Tl"
                                            });
                                        </script>
                                        <script type="text/javascript">
                                            Calendar.setup({
                                                inputField   : "beginning_date",
                                                ifFormat     : "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                button       : "beginning_date",
                                                align        : "Tl"
                                            });
                                        </script>
                                    </li>
                                    <li>
                                        <label for="enddate">Subscription end date:</label>
                                        <input type="text" name="enddate" value="<!-- TMPL_VAR name="enddate" -->" size="13" maxlength="10" id="enddate" readonly="readonly" />
                                        <img src="<!-- TMPL_VAR Name="themelang" -->/lib/calendar/cal.gif" id="button3" style="cursor: pointer;" alt="Show Calendar" title="Show Calendar" />
                                        <!-- both scripts for calendar must follow the input field --> 
                                        <script type="text/javascript">
                                            Calendar.setup({
                                                inputField   : "enddate",
                                                ifFormat     : "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                button       : "button3",
                                                align        : "Tl"
                                            });
                                        </script>
                                        <script type="text/javascript">
                                            Calendar.setup({
                                                inputField   : "enddate",
                                                ifFormat     : "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                button       : "enddate",
                                                align        : "Tl"
                                            });
                                        </script>
                                    </li>
                                    <li>
                                        <label for="numberpattern"> Numbering pattern:</label>
                                        <select name="numbering_pattern" size="1" id="numberpattern">
                                            <option value="">-- please choose --</option>
                                            <!--TMPL_LOOP Name="numberpatterns"-->
                                                <option value="<!--TMPL_VAR Name="id"-->" <!--TMPL_IF name="selected"--> selected="selected" <!-- /TMPL_IF -->>
                                                    <!--TMPL_VAR Name="label"-->
                                                </option>
                                            <!--/TMPL_LOOP-->
                                        </select>
                                    </li>
                                    <li>
                                        <label for="numberingmethod">Numbering formula:</label>
                                        <input readonly="readonly" type="text" name="numberingmethod" id="numberingmethod" size="70" value="<!-- TMPL_VAR name="numberingmethod" -->" />
                                    </li>
                                    <li id="more_options">
                                        <table id="moreoptionst">
                                            <thead>
                                                <tr>
                                                    <th>&nbsp;</th>
                                                    <th id="headerX">&nbsp;</th>
                                                    <th id="headerY">&nbsp;</th>
                                                    <th id="headerZ">&nbsp;</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Begins with</td>
                                                    <td id="beginsX"><input type="text" id="lastvaluetemp1" name="lastvaluetemp1" /></td>
                                                    <td id="beginsY"><input type="text" id="lastvaluetemp2" name="lastvaluetemp2" /></td>
                                                    <td id="beginsZ"><input type="text" id="lastvaluetemp3" name="lastvaluetemp3" /></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="action">
                                <input type="button" value="<< Previous" onclick="show_page_1();" style="float:left;"/>
                                <input type="button" value="Test prediction pattern" onclick="showPredictionPattern();" />
                                <input type="button" value="Save subscription" onclick="if (Check_page2) submit();" style="float:right;" accesskey="w" />
                            </fieldset>
                        </div>
                    </div>
                    <div class="yui-u">
                        <li id="displayexample"></li>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- TMPL_INCLUDE NAME="intranet-bottom.inc" -->
