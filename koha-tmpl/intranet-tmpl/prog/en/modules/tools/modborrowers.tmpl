<!-- TMPL_INCLUDE NAME="doc-head-open.inc" -->
<!-- TMPL_INCLUDE NAME="calendar.inc" -->
<title>Koha &rsaquo; Tools &rsaquo; <!-- TMPL_IF NAME="del" -->Batch item deletion<!-- TMPL_ELSE -->Batch item modification<!-- /TMPL_IF --> </title>
<!-- TMPL_INCLUDE NAME="doc-head-close.inc" -->
<script type="text/javascript" src="<!-- TMPL_VAR name="themelang" -->/lib/jquery/plugins/jquery.tablesorter.min.js"></script>
<script type="text/JavaScript" language="JavaScript">
//<![CDATA[
        var patron_attributes_lib = new Array();
        var patron_attributes_values = new Array();
        $(document).ready(function() {
            $("#borrowerst").tablesorter();

            $("#selectallbutton").click(function() {
                $("#borrowerst").find("input:checkbox").each(function() {
                    $(this).attr("checked", true);
                });
                return false;
            });
            $("#clearallbutton").click(function() {
                $("#borrowerst").find("input:checkbox").each(function() {
                    $(this).attr("checked", false);
                });
                return false;
            });

            var values = new Array();
            var lib = new Array();
            <!-- TMPL_LOOP NAME="patron_attributes_values" -->
                values = new Array();
                lib = new Array();
                <!-- TMPL_LOOP NAME="options" -->
                    values.push("<!-- TMPL_VAR NAME="lib" -->");
                    lib.push("<!-- TMPL_VAR NAME="authorised_value" -->");
                <!-- /TMPL_LOOP -->
                patron_attributes_lib["<!-- TMPL_VAR NAME="attribute_code" -->"] = values;
                patron_attributes_values["<!-- TMPL_VAR NAME="attribute_code" -->"] = lib;
            <!-- /TMPL_LOOP -->

            $('select[name="patron_attributes"]').change(function() {
                updateAttrValues(this);
            } );

            $('select[name="patron_attributes"]').change();

        } );

        function updateAttrValues (select_attr) {
            var attr_code = $(select_attr).val();
            var select = $(select_attr).parent().parent().find('select[name="patron_attributes_value"]');
            var options = '<option value = ""></option>';
            for ( var i = 0 ; i < patron_attributes_values[attr_code].length ; i++ ) {
                options += '<option value="'+patron_attributes_values[attr_code][i]+'">'+patron_attributes_lib[attr_code][i]+'</option>';
            }
            select.html(options);
        }

        function add_attributes() {
            var li_node = $("li.attributes:last");
            var li_clone = $(li_node).clone();
            if ( $(li_clone).find("a.delete").length == 0 ) {
                $(li_clone).append('[<a href="#" title="Delete" class="delete" onclick="del_attributes(this);return false;">X</a>]');
            }
            $(li_clone).find('select[name="patron_attributes"]').change(function() {
                updateAttrValues(this);
            } );

            $(li_clone).find('select[name="patron_attributes"]').change();

            $("#fields_list>ol").append(li_clone);
            update_attr_values();
        }

        function del_attributes(a_node) {
            $(a_node).parent('li').remove();
            update_attr_values();
        }

        function update_attr_values() {
            $("li.attributes").each(function(i) {
                $(this).find("input:checkbox").val("attr"+i+"_value");
            });
        }
        function clearDate(nodeid) {
            $("#"+nodeid).val("");
        }

//]]>
</script>
</head>
<body>
<!-- TMPL_INCLUDE NAME="header.inc" -->
<!-- TMPL_INCLUDE NAME="cat-search.inc"-->

<div id="breadcrumbs">
    <a href="/cgi-bin/koha/mainpage.pl">Home</a> &rsaquo;
    <a href="/cgi-bin/koha/tools/tools-home.pl">Tools</a> &rsaquo;
    <a href="/cgi-bin/koha/tools/modborrowers.pl">Patrons modification</a>
</div>

<div id="doc3" class="yui-t2">
    <div id="bd">
        <div id="yui-main">
            <div class="yui-b">
                <!-- TMPL_IF EXPR="op eq 'show_form'" -->
                <h1>Batch patrons modification</h1>
                <form method="post" enctype="multipart/form-data" action="/cgi-bin/koha/tools/modborrowers.pl">
                    <fieldset class="rows">
                    <legend>Use a file</legend>
                    <label for="uploadfile">File: </label> <input type="file" id="uploadfile" name="uploadfile" />
                    </fieldset>
                    <fieldset class="rows">
                        <legend>Or list cardnumbers one by one</legend>
                        <ol>
                            <li>
                              <label for="cardnumberlist">Carnumber list (one cardnumber per line): </label>
                              <textarea rows="10" cols="30" id="cardnumberlist" name="cardnumberlist"><!-- TMPL_VAR NAME="cardnumberlist" --></textarea>
                            </li>
                        </ol>
                    </fieldset>
                    <input type="hidden" name="op" value="show" />
                    <fieldset class="action">
                        <input type="submit" value="Continue" class="button" />
                        <a class="cancel" href="/cgi-bin/koha/tools/tools-home.pl">Cancel</a>
                    </fieldset>
                </form>
                <!-- /TMPL_IF -->

                <!-- TMPL_IF EXPR="op eq 'show' or op eq 'show_results'" -->
                    <!-- TMPL_IF EXPR="op eq 'show'" -->
                        <h1>Batch patrons modification</h1>
                    <!-- TMPL_ELSE -->
                        <h1>Batch patrons results</h1>
                    <!-- /TMPL_IF -->
                    <!-- TMPL_IF NAME="notfoundcardnumbers" -->
                        <div class="dialog alert"><p>Warning, the following cardnumbers were not found:</p></div>
                        <table style="margin:auto;">
                            <thead>
                                <tr><th>Cardnumbers not found</th></tr>
                            </thead>
                            <tbody>
                                <!-- TMPL_LOOP NAME="notfoundcardnumbers" -->
                                    <tr><td><!-- TMPL_VAR NAME="cardnumber" --></td></tr>
                                <!-- /TMPL_LOOP -->
                            </tbody>
                        </table>
                        <br/>
                    <!-- /TMPL_IF -->

                    <!-- TMPL_IF EXPR="op eq 'show_results'" -->
                        <!-- TMPL_IF NAME="errors" -->
                            Errors occured :
                            <ul class="warnings">
                            <!-- TMPL_LOOP NAME="errors" -->
                                <!-- TMPL_IF EXPR="error eq 'can_not_update'" -->
                                    <li>Can not update borrower with borrowernumber <!-- TMPL_VAR NAME="borrowernumber" --></li>
                                <!-- TMPL_ELSE -->
                                    <li><!-- TMPL_VAR NAME="error" --></li>
                                <!-- /TMPL_IF -->
                            <!-- /TMPL_LOOP -->
                            </ul>
                        <!-- /TMPL_IF -->
                        <br/>
                    <!-- /TMPL_IF -->

                    <!-- TMPL_IF EXPR="op eq 'show'" -->
                    <form name="f" action="modborrowers.pl" method="post">
                        <input type="hidden" name="op" value="action" />
                        <!-- TMPL_IF NAME="borrowers" -->
                            <div id="toolbar"><a id="selectallbutton" href="#">Select All</a> | <a id="clearallbutton" href="#">Clear All</a></div>
                        <!-- /TMPL_IF -->
                    <!-- /TMPL_IF -->
                            <div id="cataloguing_additem_itemlist">
                                <div style="overflow:auto">
                                    <table id="borrowerst">
                                        <thead>
                                            <tr>
                                                <!-- TMPL_IF EXPR="op eq 'show'" -->
                                                    <th>&nbsp;</th>
                                                <!-- /TMPL_IF -->
                                                <th>Surname</th>
                                                <th>Firstname</th>
                                                <th>Branchname</th>
                                                <th>Categorycode</th>
                                                <th>Cardnumber</th>
                                                <th>dateenrolled</th>
                                                <th>dateexpiry</th>
                                                <th>debarred</th>
                                                <!-- TMPL_LOOP NAME="attributes_header" -->
                                                    <th><!-- TMPL_VAR NAME="attribute" --></th>
                                                <!-- /TMPL_LOOP -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- TMPL_LOOP NAME="borrowers" -->
                                                <tr>
                                                    <!-- TMPL_IF EXPR="op eq 'show'" -->
                                                        <td><input type="checkbox" name="borrowernumber" value="<!--TMPL_VAR Name="borrowernumber"-->" checked="checked" /></td>
                                                    <!-- /TMPL_IF -->
                                                    <td><!-- TMPL_VAR NAME="surname" --></td>
                                                    <td><!-- TMPL_VAR NAME="firstname" --></td>
                                                    <td><!-- TMPL_VAR NAME="branchname" --></td>
                                                    <td><!-- TMPL_VAR NAME="category_description" --></td>
                                                    <td><!-- TMPL_VAR NAME="cardnumber" --></td>
                                                    <td><!-- TMPL_VAR NAME="dateenrolled" --></td>
                                                    <td><!-- TMPL_VAR NAME="dateexpiry" --></td>
                                                    <td><!-- TMPL_VAR NAME="debarred" --></td>
                                                    <!-- TMPL_LOOP NAME = "patron_attributes" -->
                                                        <!-- TMPL_IF NAME="code" -->
                                                            <td><!-- TMPL_VAR NAME="code" -->=<!-- TMPL_IF NAME="value_description" --><!-- TMPL_VAR NAME="value_description" --><!-- TMPL_ELSE --><!-- TMPL_VAR NAME="value" --><!-- /TMPL_IF --></td>
                                                        <!-- TMPL_ELSE -->
                                                            <td></td>
                                                        <!-- /TMPL_IF -->
                                                    <!-- /TMPL_LOOP -->
                                                </tr>
                                            <!-- /TMPL_LOOP -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- TMPL_IF EXPR="op eq 'show'" -->
                            <div id="cataloguing_additem_newitem">
                                <h2>Edit Patrons</h2>
                                <div class="hint">Checking the box right next the label will disable the entry and delete the values of that field on all selected patrons</div>
                                <fieldset class="rows" id="fields_list">
                                    <ol>
                                        <!-- TMPL_LOOP NAME="fields" -->
                                        <li>
                                            <label><!-- TMPL_VAR NAME="lib" --></label>
                                            <input type="checkbox" title="check to delete this field" name="disable_input" value="<!-- TMPL_VAR NAME="name" -->"/>
                                            <!-- TMPL_IF EXPR="type eq 'text'" -->
                                                <input type="text" name="<!-- TMPL_VAR NAME="name" -->" value="" />
                                            <!-- /TMPL_IF -->
                                            <!-- TMPL_IF EXPR="type eq 'select'" -->
                                                <select name="<!-- TMPL_VAR NAME="name" -->" >
                                                    <!-- TMPL_LOOP NAME="option" -->
                                                        <option value="<!-- TMPL_VAR NAME="value" -->"><!-- TMPL_VAR NAME="lib" --></option>
                                                    <!-- /TMPL_LOOP -->
                                                </select>
                                            <!-- /TMPL_IF -->
                                            <!-- TMPL_IF EXPR="type eq 'date'" -->
                                                <img src="<!-- TMPL_VAR Name="themelang" -->/lib/calendar/cal.gif" style="cursor: pointer;" alt="Show Calendar" title="Show Calendar" id="<!-- TMPL_VAR NAME="name" -->button"/>
                                                <input type="text" name="<!-- TMPL_VAR NAME="name" -->" id="<!-- TMPL_VAR NAME="name" -->" value="" size="10" maxlength="10" readonly />
                                                <a href="#" onclick="clearDate('<!-- TMPL_VAR NAME="name" -->');return false;">X</a>
                                                <script type="text/javascript">
                                                 //<![CDATA[ 
                                                Calendar.setup({
                                                    inputField      : "<!-- TMPL_VAR NAME="name" -->", 
                                                    button          : "<!-- TMPL_VAR NAME="name" -->button",
                                                    ifFormat        : "<!-- TMPL_VAR NAME="DHTMLcalendar_dateformat" -->",
                                                    onClose: function() { $("#<!-- TMPL_VAR NAME="name" -->").change(); this.hide();}
                                                });
                                                //]]>
                                                </script>
                                            <!-- /TMPL_IF -->
                                        </li>
                                        <!-- /TMPL_LOOP -->
                                        <li class="attributes">
                                            <label>Attribute
                                                <select name="patron_attributes">
                                                    <!-- TMPL_LOOP NAME="patron_attributes_codes" -->
                                                        <option value="<!-- TMPL_VAR NAME="attribute_code" -->"><!-- TMPL_VAR NAME="attribute_code" --></option>
                                                    <!-- /TMPL_LOOP -->
                                                </select>
                                            </label>
                                            <input type="checkbox" title="check to delete this field" name="disable_input" value="attr0_value" />
                                            <select name="patron_attributes_value"></select>
                                            <a href="#" title="Add an attribute" onclick="add_attributes(); return false;">+</a>
                                        </li>
                                    </ol>
                                </fieldset>
                                <fieldset class="action">
                                    <input type="submit" name="mainformsubmit" value="Save" />
                                    <a href="/cgi-bin/koha/tools/modborrowers.pl" class="cancel">Cancel</a>
                                </fieldset>
                            </div>
                        <!-- /TMPL_IF -->
                        <!-- /TMPL_IF -->
                    </form>
                <!-- /TMPL_IF -->
                <!-- TMPL_IF EXPR="op eq 'show_results'" -->
                    <br/>
                    <a href="/cgi-bin/koha/tools/modborrowers.pl" title="new Batch patrons modification">new Batch patrons modification</a>
                <!-- /TMPL_IF -->
            </div>
            </div>
            <div class="yui-b">
                <!-- TMPL_INCLUDE NAME="tools-menu.inc" -->
            </div>
        </div>
    </div>
</div>
</body>
</html>
